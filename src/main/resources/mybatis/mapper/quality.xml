<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="quality">

	<!--부적합품 리스트 -->

	<select id="getNonProductManageList" parameterType="Quality"
		resultType="Quality">
		SELECT *
		FROM tb_non_product_manage
		<where>
			<if test="equipment_name != null and equipment_name != 'ALL'">

				AND equipment = #{equipment_name}
			</if>

			<if test="startDate != null and startDate != ''">
				AND action_date <![CDATA[>=]]>
				#{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND action_date <![CDATA[<=]]>
				#{endDate}
			</if>
		</where>
		ORDER BY action_date DESC
	</select>


	<insert id="saveNonProductManage" parameterType="Quality">
		INSERT INTO
		tb_non_product_manage (
		no, defect_date, defect_type, equipment,
		product_no, product_name,
		defect_lot, worker, action, selection_method,
		action_date,
		defect_quantity, cause, improvement, yn_a, yn_b,
		start_date
		)
		VALUES (
		#{no}, #{defect_date}, #{defect_type},
		#{equipment}, #{product_no},
		#{product_name},
		#{defect_lot}, #{worker},
		#{action}, #{selection_method}, #{action_date},
		#{defect_quantity},
		#{cause}, #{improvement}, #{yn_a}, #{yn_b},
		#{start_date}
		)
	</insert>


	<delete id="delNonProductManage" parameterType="string">
		DELETE FROM
		tb_non_product_manage
		WHERE no = #{no}
	</delete>




	<select id="getqualityList" parameterType="Quality"
		resultType="Quality">
		SELECT *
		FROM tb_tustest
		<where>
			<if test="mch_name != null and mch_name != ''">
				AND mch_name = #{mch_name}
			</if>
			<if test="t_year != null and t_year != ''">
				AND t_year = #{t_year}
			</if>
		</where>
		ORDER BY id DESC
	</select>

	<insert id="savetusTest" parameterType="Quality">
		INSERT INTO tb_tustest (
		id, mch_name, t_year, t_month, t_url, t_ok,
		t_gb, t_day, t_min,
		t_result
		) VALUES (
		#{id}, #{mch_name}, #{t_year}, #{t_month}, #{t_url},
		#{t_ok},
		#{t_gb}, #{t_day}, #{t_min}, #{t_result}
		)
		ON DUPLICATE KEY
		UPDATE
		mch_name = VALUES(mch_name),
		t_year = VALUES(t_year),
		t_month =
		VALUES(t_month),
		t_url = VALUES(t_url),
		t_ok = VALUES(t_ok),
		t_gb =
		VALUES(t_gb),
		t_day = VALUES(t_day),
		t_min = VALUES(t_min),
		t_result =
		VALUES(t_result)
	</insert>


	<!-- 3. deltusTest: id 기준으로 삭제 -->
	<delete id="deltusTest" parameterType="Quality">
		DELETE FROM tb_tustest
		WHERE id = #{id}
	</delete>

	<!-- 수입검사 데이터 조회 -->
	<select id="getIncomingTestList" parameterType="Quality"
		resultType="Quality">
		SELECT *
		FROM tb_incoming_test
		<where>
			<if test="page != null and page != '제품 규격'">
				AND page = #{page}
			</if>
			<if test="supplier != null and supplier != 'ALL'">
				AND in_day LIKE CONCAT(#{in_day}, '%')
			</if>
		</where>
	</select>

	<!-- 수입검사 데이터 하나 조회 -->
	<select id="getIncomingTest" parameterType="Quality"
		resultType="Quality">
		SELECT *
		FROM tb_incoming_test
		WHERE no = #{no}
	</select>

	<!-- 수입검사 추가 -->
	<insert id="insertIncoming" parameterType="Quality">
    INSERT INTO tb_incoming_test (
        in_day,
        page,
        supplier,
        medicine,
        lot,
        nv_1,
        nv_2,
        color_1,
        color_2,
        sensuality_1_1,
        sensuality_1_2,
        sensuality_2_1,
        sensuality_2_2,
        confirm,
        file_name,
        writer,
        confirmer,
        ph_1,
        ph_2,
        specific_gravity_1,
        specific_gravity_2,
        viscosity_1,
        viscosity_2,
        hardness_1,
        hardness_2,
        short_1,
        short_2,
        appearance_1,
        appearance_2,
        ex_1_1,
        ex_1_2,
        ex_2_1,
        ex_2_2,
        result,
        update_id
    )
    VALUES (
        #{in_day},
        #{page},
        #{supplier},
        #{medicine},
        #{lot},
        #{nv_1},
        #{nv_2},
        #{color_1},
        #{color_2},
        #{sensuality_1_1},
        #{sensuality_1_2},
        #{sensuality_2_1},
        #{sensuality_2_2},
        #{confirm},
        #{file_name},
        #{writer},
        #{confirmer},
        #{ph_1},
        #{ph_2},
        #{specific_gravity_1},
        #{specific_gravity_2},
        #{viscosity_1},
        #{viscosity_2},
        #{hardness_1},
        #{hardness_2},
        #{short_1},
        #{short_2},
        #{appearance_1},
        #{appearance_2},
        #{ex_1_1},
        #{ex_1_2},
        #{ex_2_1},
        #{ex_2_2},
        #{result},
        #{update_id}
    )
	</insert>

	<!--수입검사 삭제 -->
	<delete id="deleteIncoming" parameterType="quality">
		DELETE FROM
		tb_incoming_test
		WHERE no = #{no}
	</delete>

	<!-- 수입검사 수정 -->
	<update id="updateIncoming" parameterType="quality">
    UPDATE tb_incoming_test
    <set>
        <if test="in_day != null and in_day != ''">in_day = #{in_day},</if>
        <if test="page != null and page != ''">page = #{page},</if>
        <if test="supplier != null and supplier != ''">supplier = #{supplier},</if>
        <if test="medicine != null and medicine != ''">medicine = #{medicine},</if>
        <if test="lot != null and lot != ''">lot = #{lot},</if>
        <if test="nv_1 != null and nv_1 != ''">nv_1 = #{nv_1},</if>
        <if test="nv_2 != null and nv_2 != ''">nv_2 = #{nv_2},</if>
        <if test="color_1 != null and color_1 != ''">color_1 = #{color_1},</if>
        <if test="color_2 != null and color_2 != ''">color_2 = #{color_2},</if>
        <if test="sensuality_1_1 != null and sensuality_1_1 != ''">sensuality_1_1 = #{sensuality_1_1},</if>
        <if test="sensuality_2_1 != null and sensuality_2_1 != ''">sensuality_2_1 = #{sensuality_2_1},</if>
        <if test="sensuality_1_2 != null and sensuality_1_2 != ''">sensuality_1_2 = #{sensuality_1_2},</if>
        <if test="sensuality_2_2 != null and sensuality_2_2 != ''">sensuality_2_2 = #{sensuality_2_2},</if>
        <if test="confirm != null and confirm != ''">confirm = #{confirm},</if>
        <if test="file_name != null and file_name != ''">file_name = #{file_name},</if>
        <if test="writer != null and writer != ''">writer = #{writer},</if>
        <if test="confirmer != null and confirmer != ''">confirmer = #{confirmer},</if>
        <if test="ph_1 != null and ph_1 != ''">ph_1 = #{ph_1},</if>
        <if test="ph_2 != null and ph_2 != ''">ph_2 = #{ph_2},</if>
        <if test="specific_gravity_1 != null and specific_gravity_1 != ''">specific_gravity_1 = #{specific_gravity_1},</if>
        <if test="specific_gravity_2 != null and specific_gravity_2 != ''">specific_gravity_2 = #{specific_gravity_2},</if>
        <if test="viscosity_1 != null and viscosity_1 != ''">viscosity_1 = #{viscosity_1},</if>
        <if test="viscosity_2 != null and viscosity_2 != ''">viscosity_2 = #{viscosity_2},</if>
        <if test="hardness_1 != null and hardness_1 != ''">hardness_1 = #{hardness_1},</if>
        <if test="hardness_2 != null and hardness_2 != ''">hardness_2 = #{hardness_2},</if>
        <if test="short_1 != null and short_1 != ''">short_1 = #{short_1},</if>
        <if test="short_2 != null and short_2 != ''">short_2 = #{short_2},</if>
        <if test="appearance_1 != null and appearance_1 != ''">appearance_1 = #{appearance_1},</if>
        <if test="appearance_2 != null and appearance_2 != ''">appearance_2 = #{appearance_2},</if>
        <if test="ex_1_1 != null and ex_1_1 != ''">ex_1_1 = #{ex_1_1},</if>
        <if test="ex_1_2 != null and ex_1_2 != ''">ex_1_2 = #{ex_1_2},</if>
        <if test="ex_2_1 != null and ex_2_1 != ''">ex_2_1 = #{ex_2_1},</if>
        <if test="ex_2_2 != null and ex_2_2 != ''">ex_2_2 = #{ex_2_2},</if>
        <if test="result != null and result != ''">result = #{result},</if>
        <if test="update_id != null and update_id != ''">update_id = #{update_id},</if>
    </set>
    WHERE no = #{no}
	</update>
	
	
		<select id="getTest_infoList" parameterType="quality" resultType="quality">
		 SELECT *
		    FROM tb_test_info
		    
		    <where>
		        <if test="coating_nm != null and coating_nm != ''">
	            	AND COATING_NM LIKE '%'||#{coating_nm}||'%'
		        </if>
		    
		    
		    	<if test="group_id != null and group_id != ''">
	            	AND GROUP_ID LIKE '%'||#{group_id}||'%'
		        </if>
		        <if test="item_cd != null and item_cd != ''">
		            AND ITEM_CD LIKE '%'||#{item_cd}||'%'
		        </if>
		        <if test="item_nm != null and item_nm != ''">
		            AND ITEM_NM LIKE '%'||#{item_nm}||'%'
		        </if>
		        

	    </where>
	        ORDER BY UPD_DT DESC
	</select>
    
	<insert id="saveTest_infoList" parameterType="condition">
	  INSERT INTO tb_test_info (
	    group_id,
	    item_cd,
	    item_nm,
	    coating_nm,
	    sample_f,
	    area_g,
	    total_area_h,
	    user_id
	  )
	  VALUES (
	    #{group_id},
	    #{item_cd},
	    #{item_nm},
	    #{coating_nm},
	    #{sample_f},
	    #{area_g},
	    #{total_area_h},
	    #{user_id}
	  )
	  ON DUPLICATE KEY UPDATE
	    group_id = VALUES(group_id),
	    item_nm = VALUES(item_nm),
	    coating_nm = VALUES(coating_nm),
	    sample_f = VALUES(sample_f),
	    area_g = VALUES(area_g),
	    total_area_h = VALUES(total_area_h),
	    user_id = VALUES(user_id)
	</insert>


    
        <delete id="delTest_infoList" parameterType="quality">
        DELETE FROM tb_test_info 
        WHERE item_cd = #{item_cd}
    	</delete>
    	
    		<select id="getMedicineList1" parameterType="Quality"
		resultType="Quality">
		SELECT *
		FROM tb_medicine_standard
		<where>
				table_code = '1'
		</where>
	</select>

	<select id="getMedicineList2" parameterType="Quality"
		resultType="Quality">
		SELECT *
		FROM tb_medicine_standard
		<where>
				table_code = '2'
		</where>
	</select>
	
		<!-- 수입검사 수정 -->
	<update id="updateMedicineStandard" parameterType="quality">
		UPDATE tb_medicine_standard
		<set>
			<if test="naoh_result != null and naoh_result != ''">naoh_result = #{naoh_result},</if>
			<if test="hcl != null and hcl != ''">hcl = #{hcl},</if>
			<if test="liter != null and liter != ''">liter = #{liter},</if>
			<if test="naoh != null and naoh != ''">naoh = #{naoh},</if>
			<if test="sc300a != null and sc300a != ''">sc300a = #{sc300a},</if>
			<if test="sc300b != null and sc300b != ''">sc300b = #{sc300b},</if>
			<if test="condense != null and condense != ''">condense = #{condense},</if>
			<if test="after_naoh != null and after_naoh != ''">after_naoh = #{after_naoh},</if>
		</set>
		WHERE num = #{num}
	</update>
	
		<!-- 테스트 관리대장 -->
<select id="getTestManageList" parameterType="Quality"
        resultType="Quality">
    SELECT *
    FROM tb_test_manage
    WHERE 1=1
    <if test="date != null and date != ''">
         AND `date` LIKE CONCAT(#{date}, '%')
    </if>
    ORDER BY `date` ASC
</select>

		<!-- 테스트 관리대장 수정 -->
	<update id="updateTestManage" parameterType="quality">
		UPDATE tb_test_manage
		<set>
			<if test="sst1 != null and sst1 != ''">sst1 = #{sst1},</if>
			<if test="sst2 != null and sst2 != ''">sst2 = #{sst2},</if>
			<if test="sst3 != null and sst3 != ''">sst3 = #{sst3},</if>
			<if test="cct1 != null and cct1 != ''">cct1 = #{cct1},</if>
			<if test="cct2 != null and cct2 != ''">cct2 = #{cct2},</if>
			<if test="cct3 != null and cct3 != ''">cct3 = #{cct3},</if>
			<if test="contact1 != null and contact1 != ''">contact1 = #{contact1},</if>
			<if test="contact2 != null and contact2 != ''">contact2 = #{contact2},</if>
			<if test="contact3 != null and contact3 != ''">contact3 = #{contact3},</if>
			<if test="gattach1 != null and gattach1 != ''">gattach1 = #{gattach1},</if>
			<if test="gattach2 != null and gattach2 != ''">gattach2 = #{gattach2},</if>
			<if test="gattach3 != null and gattach3 != ''">gattach3 = #{gattach3},</if>
			<if test="after_attach1 != null and after_attach1 != ''">after_attach1 = #{after_attach1},</if>
			<if test="after_attach2 != null and after_attach2 != ''">after_attach2 = #{after_attach2},</if>
			<if test="after_attach3 != null and after_attach3 != ''">after_attach3 = #{after_attach3},</if>
			<if test="heat1 != null and heat1 != ''">heat1 = #{heat1},</if>
			<if test="heat2 != null and heat2 != ''">heat2 = #{heat2},</if>
			<if test="heat3 != null and heat3 != ''">heat3 = #{heat3},</if>
			<if test="clean1 != null and clean1 != ''">clean1 = #{clean1},</if>
			<if test="clean2 != null and clean2 != ''">clean2 = #{clean2},</if>
			<if test="clean3 != null and clean3 != ''">clean3 = #{clean3},</if>
			<if test="shot1 != null and shot1 != ''">shot1 = #{shot1},</if>
			<if test="shot2 != null and shot2 != ''">shot2 = #{shot2},</if>
			<if test="shot3 != null and shot3 != ''">shot3 = #{shot3},</if>
			<if test="etc1 != null and etc1 != ''">etc1 = #{etc1},</if>
			<if test="etc2 != null and etc1 != ''">etc2 = #{etc2},</if>
			<if test="etc3 != null and etc1 != ''">etc3 = #{etc3},</if>
			<if test="etc4 != null and etc1 != ''">etc4 = #{etc4},</if>
			<if test="etc5 != null and etc1 != ''">etc5 = #{etc5},</if>
			<if test="etc6 != null and etc1 != ''">etc6 = #{etc6},</if>
		</set>
		WHERE number = #{number}
	</update>
	
		
	<!-- 테스트/시험정보 탱크액 추가 -->
		<insert id="testTankInsert" parameterType="Quality">
		INSERT INTO
		tb_test_tank (
		test_num, date, mch_name, hafter_1,
		empty_2, hbefore_3,
		action, min_spec, max_spec, file_name
		)
		VALUES (
		#{test_num}, #{date}, #{mch_name}, #{hafter_1},
		#{empty_2}, #{hbefore_3},
		#{action},
		#{min_spec}, #{max_spec}, #{file_name}
		)
	</insert>
	<!-- 테스트/시험정보 탱크액 리스트 조회 -->
		<select id="getTestTankList" parameterType="Quality"
		resultType="Quality">
    SELECT 
        *,
        ((hafter_1 - empty_2) / hbefore_3) * 100 AS etc1,
        CASE
            WHEN ((hafter_1 - empty_2) / hbefore_3) * 100 BETWEEN min_spec AND max_spec THEN '합격'
            ELSE '불합격'
        END AS etc2
    FROM tb_test_tank
    WHERE 1=1
    <if test="date != null and date != ''">
         AND `date` = #{date}
    </if>
	</select>
	<!-- 테스트/시험정보 탱크액 삭제 -->
		<delete id="testTankDelete" parameterType="Quality">
		DELETE FROM
		tb_test_tank
		WHERE test_num = #{test_num}
	</delete>
	
	<!-- 테스트/시험정보 첫 번째 테이블 추가 -->
		<insert id="data1Insert" parameterType="Quality">
		INSERT INTO
		tb_clean12 (
		test_num, date, mch_name, acid_reduce,
		naoh_density, min_spec, max_spec, file_name
		)
		VALUES (
		#{test_num}, #{date}, #{mch_name}, #{acid_reduce},
		#{naoh_density}, #{min_spec}, #{max_spec}, #{file_name}
		)
	</insert>
	
	<!-- 테스트/시험정보 첫 번째 테이블 조회 -->
<select id="getDataList1" parameterType="Quality" resultType="Quality">
  SELECT
      c.id,
      c.test_num,
      c.date,
      c.mch_name,
      c.acid_reduce,
      c.naoh_density,
      c.min_spec,
      c.max_spec,
      c.file_name,

      /* 조인 실패시 '범위값초과', 조인 성공시 스펙 범위 판정 */
      CASE
        WHEN
          CAST(NULLIF(TRIM(REPLACE(REPLACE(c.naoh_density, ',', ''), '%','')), '') AS DECIMAL(10,2))
          BETWEEN
          CAST(NULLIF(TRIM(REPLACE(REPLACE(c.min_spec,     ',', ''), '%','')), '') AS DECIMAL(10,2))
          AND
          CAST(NULLIF(TRIM(REPLACE(REPLACE(c.max_spec,     ',', ''), '%','')), '') AS DECIMAL(10,2))
        THEN '합격'
        ELSE '불합격'
      END AS result,

      /* m 테이블 값은 조인 실패 시 0으로 대체 */
      IFNULL(m.num, 0)         AS standard_num,
      IFNULL(m.naoh_result, 0) AS naoh_result,
      IFNULL(m.hcl, 0)         AS hcl,
      IFNULL(m.liter, 0)       AS liter,
      IFNULL(m.naoh, 0)        AS naoh,
      IFNULL(m.sc300a, 0)      AS sc300a,
      IFNULL(m.sc300b, 0)      AS sc300b,
      IFNULL(m.condense, 0)    AS condense,
      IFNULL(m.after_naoh, 0)  AS after_naoh,
      IFNULL(m.table_code, 0)  AS table_code

  FROM tb_clean12 c
  LEFT JOIN tb_medicine_standard m
    ON m.naoh_result = (
         FLOOR(
           CAST(NULLIF(TRIM(REPLACE(REPLACE(c.naoh_density, ',', ''), '%','')), '') AS DECIMAL(10,2)) / 2
         ) * 2
       )
   AND (
        (c.mch_name = '1호기' AND m.table_code = 1)
     OR (c.mch_name = '2호기' AND m.table_code = 2)
       )

  WHERE 1 = 1
  <if test="date != null and date != ''">
    AND c.date = #{date}
  </if>
</select>

	
		
		<!-- 테스트/시험정보 첫 번째 데이터 삭제 -->
		<delete id="data1Delete" parameterType="Quality">
		DELETE FROM
		tb_clean12
		WHERE test_num = #{test_num}
	</delete>
	
		<!-- 액분석관리 -->
		<select id="getLiquidAnalyze" parameterType="Quality"
		resultType="Quality">
		SELECT *
		FROM tb_liquid_analyze
		WHERE mch_name = #{mch_name} AND table_code = #{table_code}
		AND date = #{date}
	</select>

<insert id="liquidAnalyzeInsert" parameterType="Quality">
  INSERT INTO tb_liquid_analyze
  <trim prefix="(" suffix=")" suffixOverrides=",">
    <if test="date != null and date != ''">date,</if>
    <if test="result != null and result != ''">result,</if>
    <if test="auto_track != null and auto_track != ''">auto_track,</if>
    <if test="action != null and action != ''">action,</if>
    <if test="meq_min_spec != null and meq_min_spec != ''">meq_min_spec,</if>
    <if test="meq_max_spec != null and meq_max_spec != ''">meq_max_spec,</if>
    <if test="ph_input != null and ph_input != ''">ph_input,</if>
    <if test="ph_min_spec != null and ph_min_spec != ''">ph_min_spec,</if>
    <if test="ph_max_spec != null and ph_max_spec != ''">ph_max_spec,</if>
    <if test="conductivity_input != null and conductivity_input != ''">conductivity_input,</if>
    <if test="conductivity_min_spec != null and conductivity_min_spec != ''">conductivity_min_spec,</if>
    <if test="conductivity_max_spec != null and conductivity_max_spec != ''">conductivity_max_spec,</if>
    <if test="table_code != null and table_code != ''">table_code,</if>
     <if test="mch_name != null and mch_name != ''">mch_name,</if>
  </trim>
  <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
    <if test="date != null and date != ''">#{date},</if>
    <if test="result != null and result != ''">#{result},</if>
    <if test="auto_track != null and auto_track != ''">#{auto_track},</if>
    <if test="action != null and action != ''">#{action},</if>
    <if test="meq_min_spec != null and meq_min_spec != ''">#{meq_min_spec},</if>
    <if test="meq_max_spec != null and meq_max_spec != ''">#{meq_max_spec},</if>
    <if test="ph_input != null and ph_input != ''">#{ph_input},</if>
    <if test="ph_min_spec != null and ph_min_spec != ''">#{ph_min_spec},</if>
    <if test="ph_max_spec != null and ph_max_spec != ''">#{ph_max_spec},</if>
    <if test="conductivity_input != null and conductivity_input != ''">#{conductivity_input},</if>
    <if test="conductivity_min_spec != null and conductivity_min_spec != ''">#{conductivity_min_spec},</if>
    <if test="conductivity_max_spec != null and conductivity_max_spec != ''">#{conductivity_max_spec},</if>
    <if test="table_code != null and table_code != ''">#{table_code},</if>
    <if test="mch_name != null and mch_name != ''">#{mch_name},</if>
  </trim>
</insert>

		<!-- 액분석관리 데이터 삭제 -->
		<delete id="deleteLiquidAnalyze" parameterType="Quality">
		DELETE FROM
		tb_liquid_analyze
		WHERE id = #{id}
	</delete>
		<!-- 액분석관리 N.V 추가 -->
		<insert id="liquidAnalyzeInsertNv" parameterType="Quality">
		INSERT INTO tb_liquid_analyze
  <trim prefix="(" suffix=")" suffixOverrides=",">
    <if test="date != null and date != ''">date,</if>
    <if test="action != null and action != ''">action,</if>
    <if test="meq_min_spec != null and meq_min_spec != ''">meq_min_spec,</if>
    <if test="meq_max_spec != null and meq_max_spec != ''">meq_max_spec,</if>
    <if test="table_code != null and table_code != ''">table_code,</if>
     <if test="mch_name != null and mch_name != ''">mch_name,</if>
     <if test="nv_baking != null and nv_baking != ''">nv_baking,</if>
     <if test="nv_foil != null and nv_foil != ''">nv_foil,</if>
     <if test="nv_paint != null and nv_paint != ''">nv_paint,</if>
     <if test="nv_baking != null and nv_baking != '' and 
                      nv_foil != null and nv_foil != '' and 
                      nv_paint != null and nv_paint != ''">
                result,
     </if>
  </trim>
  <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
    <if test="date != null and date != ''">#{date},</if>
    <if test="action != null and action != ''">#{action},</if>
    <if test="meq_min_spec != null and meq_min_spec != ''">#{meq_min_spec},</if>
    <if test="meq_max_spec != null and meq_max_spec != ''">#{meq_max_spec},</if>
    <if test="table_code != null and table_code != ''">#{table_code},</if>
    <if test="mch_name != null and mch_name != ''">#{mch_name},</if>
    <if test="nv_baking != null and nv_baking != ''">#{nv_baking},</if>
    <if test="nv_foil != null and nv_foil != ''">#{nv_foil},</if>
    <if test="nv_paint != null and nv_paint != ''">#{nv_paint},</if>
    <if test="nv_baking != null and nv_baking != '' and 
                      nv_foil != null and nv_foil != '' and 
                      nv_paint != null and nv_paint != ''">
                (#{nv_baking} - #{nv_foil}) / #{nv_paint} * 100,
    </if>
  </trim>
	</insert>
	<!-- 액분석관리 Ash 추가 -->
<insert id="liquidAnalyzeInsertAsh" parameterType="Quality">
    INSERT INTO tb_liquid_analyze
    (
        <trim suffixOverrides=",">
            <if test="date != null and date != ''">date,</if>
            <if test="action != null and action != ''">action,</if>
            <if test="meq_min_spec != null and meq_min_spec != ''">meq_min_spec,</if>
            <if test="meq_max_spec != null and meq_max_spec != ''">meq_max_spec,</if>
            <if test="table_code != null and table_code != ''">table_code,</if>
            <if test="mch_name != null and mch_name != ''">mch_name,</if>
            
            <if test="ash_baking != null and ash_baking != ''">ash_baking,</if>
            
            <if test="ash_do != null and ash_do != ''">ash_do,</if>
            <if test="ash_paint != null and ash_paint != ''">ash_paint,</if>
            
            <if test="ash_baking != null and ash_baking != '' and 
                      ash_do != null and ash_do != '' and 
                      ash_paint != null and ash_paint != ''">
                result,
            </if>
        </trim>
    )
    VALUES
    (
        <trim suffixOverrides=",">
            <if test="date != null and date != ''">#{date},</if>
            <if test="action != null and action != ''">#{action},</if>
            <if test="meq_min_spec != null and meq_min_spec != ''">#{meq_min_spec},</if>
            <if test="meq_max_spec != null and meq_max_spec != ''">#{meq_max_spec},</if>
            <if test="table_code != null and table_code != ''">#{table_code},</if>
            <if test="mch_name != null and mch_name != ''">#{mch_name},</if>
            
            <if test="ash_baking != null and ash_baking != ''">#{ash_baking},</if>
            
            <if test="ash_do != null and ash_do != ''">#{ash_do},</if>
            <if test="ash_paint != null and ash_paint != ''">#{ash_paint},</if>
            
            <if test="ash_baking != null and ash_baking != '' and 
                      ash_do != null and ash_do != '' and 
                      ash_paint != null and ash_paint != ''">
                (((#{ash_baking} - #{ash_do}) / (#{cause}/100 * #{ash_paint})) * 100),
            </if>
        </trim>
    )
</insert>
		<!-- KCC 분석비교 -->
		<select id="getKccList" parameterType="Quality"
		resultType="Quality">
		SELECT
		    T.date,
		    T.table_code,
		    T.mch_name,
			 T.id,
		    MAX(CASE WHEN T.mch_name = 'meq' THEN T.auto_track ELSE NULL END) AS meq_result,
		    MAX(CASE WHEN T.mch_name = 'ash' THEN T.result ELSE NULL END) AS ash_result,
		    MAX(CASE WHEN T.mch_name = 'nv' THEN T.result ELSE NULL END) AS nv_result,
		    MAX(CASE WHEN T.mch_name = 'ph' THEN T.ph_input ELSE NULL END) AS ph_result,
		    MAX(CASE WHEN T.mch_name = 'conductivity' THEN T.conductivity_input ELSE NULL END) AS conductivity_result,
			 
			 MAX(CASE WHEN T.mch_name = 'meq' THEN T.meq_kcc ELSE NULL END) AS meq_kcc,   
		    MAX(CASE WHEN T.mch_name = 'ash' THEN T.ash_kcc ELSE NULL END) AS ash_kcc,
		    MAX(CASE WHEN T.mch_name = 'nv' THEN T.nv_kcc ELSE NULL END) AS nv_kcc,
		    MAX(CASE WHEN T.mch_name = 'ph' THEN T.ph_kcc ELSE NULL END) AS ph_kcc,
		    MAX(CASE WHEN T.mch_name = 'conductivity' THEN T.conductivity_kcc ELSE NULL END) AS conductivity_kcc,
			 T.conductivity_kcc  
		FROM
		    tb_liquid_analyze T
		<where>
		<if test="date != null and date != '' and endDate != null and endDate != ''">
            AND T.date BETWEEN #{date} AND #{endDate}
        </if>
    	</where>
		GROUP BY
		    T.date,
		    T.table_code
		ORDER BY T.date asc
	</select>
	<!-- kcc 업데이트 -->
	<update id="updateKcc" parameterType="quality">
		UPDATE tb_liquid_analyze
		<set>
			<if test="meq_kcc != null and meq_kcc != ''">meq_kcc = #{meq_kcc},</if>
			<if test="nv_kcc != null and nv_kcc != ''">nv_kcc = #{nv_kcc},</if>
			<if test="ph_kcc != null and ph_kcc != ''">ph_kcc = #{ph_kcc},</if>
			<if test="ash_kcc != null and ash_kcc != ''">ash_kcc = #{ash_kcc},</if>
			<if test="conductivity_kcc != null and conductivity_kcc != ''">conductivity_kcc = #{conductivity_kcc},</if>
		</set>
		WHERE date = #{date} 
		AND mch_name = #{mch_name}
		AND table_code = #{table_code}
	</update>
		<!-- cct 추가 -->
			<insert id="insertCct" parameterType="Quality">
		INSERT INTO tb_cct
  <trim prefix="(" suffix=")" suffixOverrides=",">
    <if test="sample != null and sample != ''">sample,</if>
    <if test="part_no != null and part_no != ''">part_no,</if>
    <if test="part_name != null and part_name != ''">part_name,</if>
    <if test="spec != null and spec != ''">spec,</if>
    <if test="start_date != null and start_date != ''">start_date,</if>
     <if test="end_date != null and end_date != ''">end_date,</if>
     <if test="result != null and result != ''">result,</if>
     <if test="file_name != null and file_name != ''">file_name,</if>
  </trim>
  <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
    <if test="sample != null and sample != ''">#{sample},</if>
    <if test="part_no != null and part_no != ''">#{part_no},</if>
    <if test="part_name != null and part_name != ''">#{part_name},</if>
    <if test="spec != null and spec != ''">#{spec},</if>
    <if test="start_date != null and start_date != ''">#{start_date},</if>
    <if test="end_date != null and end_date != ''">#{end_date},</if>
    <if test="result != null and result != ''">#{result},</if>
    <if test="file_name != null and file_name != ''">#{file_name},</if>
  </trim>
	</insert>
	<!-- cct 시험성적서 조회 -->
	<select id="getCctList" parameterType="Quality" resultType="Quality">
SELECT * from tb_cct
  WHERE 1 = 1
  <if test="date != null and date != ''">
    AND DATE(regdate) = #{date}
  </if>
</select>
<!-- cct 삭제 -->
		<delete id="deleteCct" parameterType="Quality">
		DELETE FROM
		tb_cct
		WHERE cct_id = #{cct_id}
	</delete>
		<!-- sst 시험성적서 조회 -->
	<select id="getSstList" parameterType="Quality" resultType="Quality">
SELECT * from tb_sst
  WHERE 1 = 1
  <if test="date != null and date != ''">
    AND DATE(regdate) = #{date}
  </if>
</select>
	<!-- sst 추가 -->
			<insert id="insertSst" parameterType="Quality">
		INSERT INTO tb_sst
  <trim prefix="(" suffix=")" suffixOverrides=",">
    <if test="sample != null and sample != ''">sample,</if>
    <if test="part_no != null and part_no != ''">part_no,</if>
    <if test="part_name != null and part_name != ''">part_name,</if>
    <if test="spec != null and spec != ''">spec,</if>
    <if test="start_date != null and start_date != ''">start_date,</if>
     <if test="end_date != null and end_date != ''">end_date,</if>
     <if test="result != null and result != ''">result,</if>
     <if test="file_name != null and file_name != ''">file_name,</if>
  </trim>
  <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
    <if test="sample != null and sample != ''">#{sample},</if>
    <if test="part_no != null and part_no != ''">#{part_no},</if>
    <if test="part_name != null and part_name != ''">#{part_name},</if>
    <if test="spec != null and spec != ''">#{spec},</if>
    <if test="start_date != null and start_date != ''">#{start_date},</if>
    <if test="end_date != null and end_date != ''">#{end_date},</if>
    <if test="result != null and result != ''">#{result},</if>
    <if test="file_name != null and file_name != ''">#{file_name},</if>
  </trim>
	</insert>
<!-- sst 삭제 -->
		<delete id="deleteSst" parameterType="Quality">
		DELETE FROM
		tb_sst
		WHERE sst_id = #{sst_id}
	</delete>
	<!-- 지오메트 후처리 추가 -->
<insert id="insertAttachment" parameterType="Quality">
    INSERT INTO tb_attachment
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="mch_name != null and mch_name != ''">mch_name,</if>
        <if test="before_weight != null and before_weight != ''">before_weight,</if>
        <if test="after_weight != null and after_weight != ''">after_weight,</if>
        <if test="count != null and count != ''">count,</if>
        <if test="surface != null and surface != ''">surface,</if>
        <if test="viscosity != null and viscosity != ''">viscosity,</if>
        <if test="action != null and action != ''">action,</if>
        <if test="group_id != null and group_id != ''">group_id,</if>
        <if test="part_name != null and part_name != ''">part_name,</if>
        <if test="spec != null and spec != ''">spec,</if>
        <if test="count != null and count != '' and surface != null and surface != '' and before_weight != null and before_weight != '' and after_weight != null and after_weight != ''">
            calc1, calc2, calc3, result,
        </if>
        <if test="date != null and date != ''">date,</if>
    </trim>
    <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
        <if test="mch_name != null and mch_name != ''">#{mch_name},</if>
        <if test="before_weight != null and before_weight != ''">#{before_weight},</if>
        <if test="after_weight != null and after_weight != ''">#{after_weight},</if>
        <if test="count != null and count != ''">#{count},</if>
        <if test="surface != null and surface != ''">#{surface},</if>
        <if test="viscosity != null and viscosity != ''">#{viscosity},</if>
        <if test="action != null and action != ''">#{action},</if>
        <if test="group_id != null and group_id != ''">#{group_id},</if>
        <if test="part_name != null and part_name != ''">#{part_name},</if>
        <if test="spec != null and spec != ''">#{spec},</if>
        <if test="count != null and count != '' and surface != null and surface != '' and before_weight != null and before_weight != '' and after_weight != null and after_weight != ''">
            (#{count} * #{surface}),
            (#{before_weight} - #{after_weight}),
            
            (ROUND(
                (CAST((#{before_weight} - #{after_weight}) AS DECIMAL) / (CAST(#{count} AS DECIMAL) * CAST(#{surface} AS DECIMAL)) * 1000)
            , 2)),
            
            (CASE 
                WHEN #{mch_name} LIKE 'G600%' OR #{mch_name} LIKE 'G800%'
                    THEN (CASE WHEN 
                        (ROUND((CAST((#{before_weight} - #{after_weight}) AS DECIMAL) / (CAST(#{count} AS DECIMAL) * CAST(#{surface} AS DECIMAL)) * 1000), 2)) >= 200 
                        THEN '합격' 
                        ELSE '불합격' 
                    END)
                WHEN #{mch_name} LIKE '%PLUS%' OR #{mch_name} LIKE '%ML%'
                    THEN (CASE WHEN 
                        (ROUND((CAST((#{before_weight} - #{after_weight}) AS DECIMAL) / (CAST(#{count} AS DECIMAL) * CAST(#{surface} AS DECIMAL)) * 1000), 2)) >= 20 
                        THEN '합격' 
                        ELSE '불합격' 
                    END)
                WHEN #{mch_name} LIKE '%K-BLACK%'
                    THEN (CASE WHEN 
                        (ROUND((CAST((#{before_weight} - #{after_weight}) AS DECIMAL) / (CAST(#{count} AS DECIMAL) * CAST(#{surface} AS DECIMAL)) * 1000), 2)) >= 80
                        THEN '합격' 
                        ELSE '불합격' 
                    END)
                ELSE '불합격' 
            END),
        </if>
        <if test="date != null and date != ''">#{date},</if>
    </trim>
</insert>
	<!-- 지오메트 부착량 조회 -->
		<select id="attachmentList" parameterType="Quality" resultType="Quality">
SELECT * from tb_attachment
  WHERE 1 = 1
  AND (mch_name LIKE 'G600%' OR mch_name LIKE 'G800%')
  <if test="date != null and date != ''">
    AND DATE(date) = #{date}
  </if>
  order by mch_name asc
</select>
<!-- 지오메트 후처리 부착량 조회 -->
		<select id="turbidityList" parameterType="Quality" resultType="Quality">
SELECT * from tb_attachment
  WHERE 1 = 1
  AND (mch_name LIKE 'PLUS%' OR mch_name LIKE 'ML%' OR mch_name LIKE 'K/B%')
  <if test="date != null and date != ''">
    AND DATE(date) = #{date}
  </if>
  order by mch_name asc
</select>
<!-- 지오메트 부착량, 후처리 부착량 삭제 -->
		<delete id="deleteAttachment" parameterType="Quality">
		DELETE FROM
		tb_attachment
		WHERE date = #{date}
		<choose>
            <when test='mch_name != null and mch_name.contains("G")'>
                AND mch_name LIKE '%G%'
            </when>
            
            <otherwise>
                AND mch_name NOT LIKE '%G%'
            </otherwise>
        </choose>
	</delete>
</mapper>