<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="machine">

    <!-- //정기점검 계획/실적  -->   
<select id="getMachineList" parameterType="machine" resultType="machine">
    SELECT 
        equipment_name,
        DATE_FORMAT(updated_at, '%Y-%m-%d') AS updated_at,
        item_type,
        m1, m2, m3, m4, m5, m6,
        m7, m8, m9, m10, m11, m12,
        save_url,
        remark
    FROM tb_check_plan
    <where>
        <if test="startDate != null and startDate != ''">
            AND YEAR(created_at) = #{startDate}
        </if>
    </where>
    ORDER BY 
        FIELD(equipment_name,
            '세척 1호기',
            '세척 2호기',
            '쇼트 1호기',
            '쇼트 2호기',
            '쇼트 3호기',
            '쇼트 4호기',
            '쇼트 5호기',
            '쇼트 6호기',
            'G600',
            'G800',
            'K-BLACK',
            '공용설비'
        ),
        CASE item_type 
            WHEN '계획' THEN 0
            WHEN '실적' THEN 1
            ELSE 2
        END
</select>



<update id="updatecheckPlan" parameterType="machine">
     UPDATE tb_check_plan
    <set>
        equipment_name = #{equipment_name},
        inspection_date = #{updated_at},
        item_type = #{item_type},
        save_url = #{save_url},
        remark = #{remark},
        <if test="m1 != null">m1 = #{m1},</if>
        <if test="m2 != null">m2 = #{m2},</if>
        <if test="m3 != null">m3 = #{m3},</if>
        <if test="m4 != null">m4 = #{m4},</if>
        <if test="m5 != null">m5 = #{m5},</if>
        <if test="m6 != null">m6 = #{m6},</if>
        <if test="m7 != null">m7 = #{m7},</if>
        <if test="m8 != null">m8 = #{m8},</if>
        <if test="m9 != null">m9 = #{m9},</if>
        <if test="m10 != null">m10 = #{m10},</if>
        <if test="m11 != null">m11 = #{m11},</if>
        <if test="m12 != null">m12 = #{m12},</if>
        updated_at = NOW()
    </set>
    WHERE equipment_name = #{equipment_name}
      AND item_type = #{item_type}
</update>





<select id="getTempDataList" parameterType="temp_data" resultType="map">
  SELECT temp_time,
  <choose>
    <when test="mch_code == 'T_600'">
      T_600_D12000, T_600_D12001
    </when>
    <when test="mch_code == 'T_800'">
      T_800_D12000, T_800_D12001
    </when>
    <when test="mch_code == 'BLK'">
      BLK_D12000, BLK_D12001
    </when>
    <when test="mch_code == 'MLPL'">
      MLPL_D12000, MLPL_D12001
    </when>
    <otherwise>
      NULL AS temp1, NULL AS temp2
    </otherwise>
  </choose>
  FROM tb_temp_data
  <where>
    <if test="startDate != null and endDate != null and startDate != '' and endDate != ''">
      temp_time BETWEEN #{startDate} AND #{endDate}
    </if>
  </where>
  ORDER BY temp_time
</select>



<select id="getAllDataList" parameterType="machine" resultType="machine">
SELECT * FROM v_moniteolingling
</select>

<select id="getNonTimeDataList" parameterType="machine" resultType="machine">
    SELECT
    	non_time_idx,
        equipment_name,
        machine_code,
        info_list,
        start_time,
      	end_time,
      	non_time_memo
    FROM tb_non_time
    <where>
        <if test="startDate != null and startDate != ''">
            AND start_time &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND start_time &lt;= #{endDate}
        </if>
        <if test="equipment_name != null and equipment_name != ''">
            AND equipment_name = #{equipment_name}
        </if>
    </where>
    ORDER BY start_time DESC
</select>





<insert id="saveNonTime" parameterType="machine">
    INSERT INTO tb_non_time (
        equipment_name,
        machine_code,
        info_list,
        start_time,
        end_time,
        non_time_memo
    )
    VALUES (
        #{equipment_name},
        #{machine_code},
        #{info_list},
        #{start_time},
        #{end_time},
        #{non_time_memo}
    )
</insert>




<update id="updateNonTime" parameterType="machine">
    UPDATE tb_non_time
    SET
        equipment_name = #{equipment_name},
        machine_code = #{machine_code},
        info_list = #{info_list},
        start_time = #{start_time},
        end_time = #{end_time},
        non_time_memo = #{non_time_memo}
    WHERE non_time_idx = #{non_time_idx}
</update>

<delete id="deleteNonTime" parameterType="string">
    DELETE FROM tb_non_time
    WHERE non_time_idx = #{non_time_idx}
</delete>




<select id="getNonTimeDataView" resultType="map">
    SELECT
        main.equipment_name AS v_equipment_name,
        main.info_list AS info_list_v,

        -- 비가동 시간 계산
        SUM(
            TIMESTAMPDIFF(
                MINUTE,
                STR_TO_DATE(main.start_time, '%Y-%m-%d %H:%i'),
                STR_TO_DATE(main.end_time, '%Y-%m-%d %H:%i')
            )
        ) AS sum_time,

        -- 시간:분 형식으로 변환
        CONCAT(
            FLOOR(SUM(
                TIMESTAMPDIFF(
                    MINUTE,
                    STR_TO_DATE(main.start_time, '%Y-%m-%d %H:%i'),
                    STR_TO_DATE(main.end_time, '%Y-%m-%d %H:%i')
                )
            ) / 60), '시간 ',
            SUM(
                TIMESTAMPDIFF(
                    MINUTE,
                    STR_TO_DATE(main.start_time, '%Y-%m-%d %H:%i'),
                    STR_TO_DATE(main.end_time, '%Y-%m-%d %H:%i')
                )
            ) % 60, '분'
        ) AS sum_time_ch,

        -- 하루 기준 최대 발생 건수
        IFNULL(day_counts.max_day_count, 0) AS day_count,

        -- 전체 발생 건수
        COUNT(*) AS month_count

    FROM tb_non_time main

    LEFT JOIN (
        SELECT
            equipment_name,
            info_list,
            MAX(day_count) AS max_day_count
        FROM (
            SELECT
                equipment_name,
                info_list,
                DATE(STR_TO_DATE(start_time, '%Y-%m-%d %H:%i')) AS event_day,
                COUNT(*) AS day_count
            FROM tb_non_time
            WHERE 1 = 1
                <if test="startDate != null and startDate != ''">
                    AND STR_TO_DATE(start_time, '%Y-%m-%d %H:%i') &gt;= #{startDate}
                </if>
                <if test="endDate != null and endDate != ''">
                    AND STR_TO_DATE(end_time, '%Y-%m-%d %H:%i') &lt;= #{endDate}
                </if>
                <if test="equipment_name != null and equipment_name != ''">
                    AND equipment_name = #{equipment_name}
                </if>
            GROUP BY equipment_name, info_list, event_day
        ) AS daily_counts
        GROUP BY equipment_name, info_list
    ) AS day_counts
    ON main.equipment_name = day_counts.equipment_name
    AND main.info_list = day_counts.info_list

    WHERE 1 = 1
        <if test="startDate != null and startDate != ''">
            AND STR_TO_DATE(main.start_time, '%Y-%m-%d %H:%i') &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND STR_TO_DATE(main.end_time, '%Y-%m-%d %H:%i') &lt;= #{endDate}
        </if>
        <if test="equipment_name != null and equipment_name != ''">
            AND main.equipment_name = #{equipment_name}
        </if>

    GROUP BY
        main.equipment_name, main.info_list

    ORDER BY month_count DESC
</select>




<insert id="insertRepairStatus" parameterType="Machine">
    INSERT INTO tb_equipment_maintenance (
        id, work_date, operator, equipment_name, inspection_type,
        downtime_flag, downtime_minutes, category_mid, category_sub,
       item_type, part_flag, action, action_detail, action_detail_2,
        replacement_type, replacement_name, part_name, part_replacement_flag,
        quantity, due_date, replacement_date, prev_replacement_date, usage_days,
        manufacturer, manager_name, contact, part_status,
        safety_stock, current_stock, purchase_qty
    ) VALUES (
        #{id}, #{work_date}, #{operator}, #{equipment_name}, #{inspection_type},
        #{downtime_flag}, #{downtime_minutes}, #{category_mid}, #{category_sub},
        #{item_type}, #{part_flag}, #{action}, #{action_detail}, #{action_detail_2},
        #{replacement_type}, #{replacement_name}, #{part_name}, #{part_replacement_flag},
        #{quantity}, #{due_date}, #{replacement_date}, #{prev_replacement_date}, #{usage_days},
        #{manufacturer}, #{manager_name}, #{contact}, #{part_status},
        #{safety_stock}, #{current_stock}, #{purchase_qty}
    )

    ON DUPLICATE KEY UPDATE
        work_date = VALUES(work_date),
        operator = VALUES(operator),
        equipment_name = VALUES(equipment_name),
        inspection_type = VALUES(inspection_type),
        downtime_flag = VALUES(downtime_flag),
        downtime_minutes = VALUES(downtime_minutes),
        category_mid = VALUES(category_mid),
        category_sub = VALUES(category_sub),
     
        item_type = VALUES(item_type),
        part_flag = VALUES(part_flag),
        action = VALUES(action),
        action_detail = VALUES(action_detail),
        action_detail_2 = VALUES(action_detail_2),
        replacement_type = VALUES(replacement_type),
        replacement_name = VALUES(replacement_name),
        part_name = VALUES(part_name),
        part_replacement_flag = VALUES(part_replacement_flag),
        quantity = VALUES(quantity),
        due_date = VALUES(due_date),
        replacement_date = VALUES(replacement_date),
        prev_replacement_date = VALUES(prev_replacement_date),
        usage_days = VALUES(usage_days),
        manufacturer = VALUES(manufacturer),
        manager_name = VALUES(manager_name),
        contact = VALUES(contact),
        part_status = VALUES(part_status),
        safety_stock = VALUES(safety_stock),
        current_stock = VALUES(current_stock),
        purchase_qty = VALUES(purchase_qty)
</insert>


<delete id="delRepairStatus" parameterType="Machine">
    DELETE FROM tb_equipment_maintenance
    WHERE id = #{id}
</delete>





<select id="getRepairStatusList_popup_i_equipment_name" parameterType="Machine" resultType="Machine">
    SELECT DISTINCT i_equipment_name
	FROM tb_equipment_maintenance_info
	ORDER BY i_equipment_name;
</select>






<select id="getRepairStatusList_info" parameterType="Machine" resultType="Machine">
    SELECT *
    FROM tb_equipment_maintenance_info
    <where>
        <if test="i_equipment_name != null and i_equipment_name != ''">
            AND i_equipment_name = #{i_equipment_name}
        </if>

    </where>
    ORDER BY idx DESC
</select>

<insert id="insertRepairStatus_info" parameterType="Machine">
    INSERT INTO tb_equipment_maintenance_info (
        i_equipment_name,
        i_category_mid,
        i_category_sub,
        i_part_name,
        i_part_status,
        i_safety_stock,
        i_manufacturer,
        i_manager_name,
        i_contact,
        i_due_date
    ) VALUES (
        #{i_equipment_name},
        #{i_category_mid},
        #{i_category_sub},
        #{i_part_name},
        #{i_part_status},
        #{i_safety_stock},
        #{i_manufacturer},
        #{i_manager_name},
        #{i_contact},
        #{i_due_date}
    )
</insert>

<update id="updateRepairStatus_info" parameterType="Machine">
    UPDATE tb_equipment_maintenance_info
    SET
        i_equipment_name = #{i_equipment_name},
        i_category_mid = #{i_category_mid},
        i_category_sub = #{i_category_sub},
        i_part_name = #{i_part_name},
        i_part_status = #{i_part_status},
        i_safety_stock = #{i_safety_stock},
        i_manufacturer = #{i_manufacturer},
        i_manager_name = #{i_manager_name},
        i_contact = #{i_contact},
        i_due_date = #{i_due_date}
    WHERE idx = #{idx}
</update>


<delete id="delRepairStatus_info" parameterType="Machine">
    DELETE FROM tb_equipment_maintenance_info
    WHERE idx = #{idx}
</delete>


<select id="getRepairStatusList" parameterType="Machine" resultType="Machine">
    SELECT *
    FROM tb_equipment_maintenance
    <where>
       <if test="equipmentName != null and equipmentName != ''">
            AND equipment_name = #{equipmentName}
       </if>
       
       <if test="startDate != null and startDate != ''">
            AND work_date LIKE CONCAT(#{startDate}, '%')
       </if>
    </where>
    ORDER BY work_date DESC, id DESC
</select>








<select id="getPartStatusList" parameterType="Machine" resultType="Machine">
  SELECT *
  FROM tb_equipment_maintenance
  <where>
      AND action = '교체'
      AND DATE_FORMAT(work_date, '%Y-%m') = #{month}

      <if test="mch_name != 'ALL'">
          AND equipment_name = #{mch_name}
      </if>

      <if test="where_bt == '조건'">
          AND purchase_qty <![CDATA[>]]> 0
      </if>
  </where>
  ORDER BY work_date ASC
</select>




<select id="workReport4" resultType="Machine">
    SELECT 
        work_date,
        equipment_name,
        category_mid,
        category_sub,
        part_name,
        purchase_qty
    FROM v_equipment_maintenance1203
</select>



	<insert id="insertPartStatus" parameterType="Machine">
	  INSERT INTO tb_part_status
	    (no,
	     mch_name,
	     chg_item,
	     chg_date,
	     reason,
	     required_info,
	     target_date,
	     change_by,
	     company_name,
	     remark)
	  VALUES
	    (#{no},
	     #{mch_name},
	     #{chg_item},
	     #{chg_date},
	     #{reason},
	     #{required_info},
	     #{target_date},
	     #{change_by},
	     #{company_name},
	     #{remark})
	  ON DUPLICATE KEY UPDATE
	    mch_name       = VALUES(mch_name),
	    chg_item       = VALUES(chg_item),
	    chg_date       = VALUES(chg_date),
	    reason         = VALUES(reason),
	    required_info  = VALUES(required_info),
	    target_date    = VALUES(target_date),
	    change_by      = VALUES(change_by),
	    company_name   = VALUES(company_name),
	    remark         = VALUES(remark)
	</insert>


  
  <delete id="delPartStatus" parameterType="Machine">
    DELETE FROM tb_part_status 
    WHERE no = #{no}
  </delete>




<select id="getSpareStatusList" parameterType="Machine" resultType="Machine">
    SELECT *
    FROM tb_equipment_maintenance
    <where>
        <if test="where_bt != null and where_bt == '조건'">
            AND purchase_qty <![CDATA[>]]> 0
        </if>

        AND part_status = '스페어'
        AND DATE_FORMAT(work_date, '%Y-%m') = #{month}

        <if test="mch_name != 'ALL'">
            AND equipment_name = #{mch_name}
        </if>
    </where>
    ORDER BY work_date ASC
</select>



<insert id="insertspareStatus" parameterType="Machine">
    INSERT INTO tb_sparestatus_status (
        no,
        mch_name,
        mch_parts,
        a_usage,
        standard,
        producer,
        replacement,
        buy_cycle,
        stock,
        now_stock,
        remark,
        day_update
    )
    VALUES (
        #{no},
        #{mch_name},
        #{mch_parts},
        #{a_usage},
        #{standard},
        #{producer},
        #{replacement},
        #{buy_cycle},
        #{stock},
        #{now_stock},
        #{remark},
        NOW()
    )
    ON DUPLICATE KEY UPDATE
        mch_name = VALUES(mch_name),
        mch_parts = VALUES(mch_parts),
        a_usage = VALUES(a_usage),
        standard = VALUES(standard),
        producer = VALUES(producer),
        replacement = VALUES(replacement),
        buy_cycle = VALUES(buy_cycle),
        stock = VALUES(stock),
        now_stock = VALUES(now_stock),
        remark = VALUES(remark),
        day_update = CURRENT_TIMESTAMP
</insert>


<delete id="delspareStatus" parameterType="Machine">
    DELETE FROM tb_sparestatus_status
    WHERE no = #{no}
</delete>








<select id="getlogStatusList" parameterType="Machine" resultType="Machine">
    SELECT *
    FROM tb_equipment_maintenance
    <where>
        <if test="where_bt != null and where_bt == '조건'">
           
        </if>

        AND replacement_type = '외주'
        AND DATE_FORMAT(work_date, '%Y-%m') = #{month}

        <if test="mch_name != 'ALL'">
            AND equipment_name = #{mch_name}
        </if>
    </where>
    ORDER BY work_date ASC
</select>



<insert id="insertlogStatus" parameterType="Machine">
  INSERT INTO tb_log_status (
    no,
    gong_date,
    mch_code,
    mch_name,
    result,
    g_b,
    gong_type,
    gong_hr,
    remark
  )
  VALUES (
    #{no},
    #{gong_date},
    #{mch_code},
    #{mch_name},
    #{result},
    #{g_b},
    #{gong_type},
    #{gong_hr},
    #{remark}
  )
  ON DUPLICATE KEY UPDATE
    gong_date = VALUES(gong_date),
    mch_code  = VALUES(mch_code),
    mch_name  = VALUES(mch_name),
    result    = VALUES(result),
    g_b       = VALUES(g_b),
    gong_type = VALUES(gong_type),
    gong_hr   = VALUES(gong_hr),
    remark    = VALUES(remark)
</insert>


 
  <delete id="dellogStatus" parameterType="Machine">
    DELETE FROM tb_log_status
    WHERE no = #{no}
  </delete>
  
  
  
<select id="getErrDataList" parameterType="Machine" resultType="Machine">
  SELECT
      e.position_cd,
      e.mach_code,
      e.facility_name,
      e.line_cd,
      e.err_code,
      e.err_name,
      e.start_time_formatted,
      e.end_time_formatted,
      e.remark
  FROM
      v_errdata e
  WHERE
    1 = 1
    <if test="mach_code != null and mach_code != 'ALL'">
      AND e.mach_code = #{mach_code}
    </if>
    AND e.start_time_formatted &gt;= #{start_time}
    AND e.end_time_formatted &lt;= #{end_time}
  ORDER BY
      e.start_time_formatted
</select>


<select id="getErrAlarmRanking" parameterType="Machine" resultType="Machine">
  SELECT
    e.mach_code,
    e.facility_name,  <!-- 설비명 추가 -->
    e.err_code,
    e.err_name,
    COUNT(*) AS alarm_count
  FROM
    v_errdata e
  WHERE
    1 = 1
    <if test="mach_code != null and mach_code != 'ALL'">
      AND e.mach_code = #{mach_code}
    </if>
    AND e.start_time_formatted <![CDATA[ >= ]]> #{start_time}
    AND e.end_time_formatted <![CDATA[ <= ]]> #{end_time}
  GROUP BY
    e.mach_code, e.facility_name, e.err_code, e.err_name  <!-- group by에 추가 -->
  ORDER BY
    alarm_count DESC
</select>





<select id="getFacilityList" resultType="Machine">
    SELECT 
        facility_code,
        facility_name,
        facility_mach_code,
        facility_comment,
        c_t,
        capa,
        std_weight,
        non_time,
        work_time2,
        facility_yn,
        ch_idx,
        std_jumdo,
        std_bijung
    FROM tb_facility
    ORDER BY ch_idx ASC
</select>




 <delete id="deleteFacility" parameterType="Machine">
    DELETE FROM tb_facility
    WHERE facility_code = #{facility_code}
</delete>
 
<insert id="insertFacility" parameterType="Machine">
    INSERT INTO tb_facility (
        facility_code,
        facility_name,
        facility_mach_code,
        facility_comment,
        c_t,
        capa,
        std_weight,
        non_time,
        work_time2,
        facility_yn,
        std_jumdo,
        std_bijung,
        ch_idx
    )
    VALUES (
        #{facility_code},
        #{facility_name},
        #{facility_mach_code},
        #{facility_comment},
        #{c_t},
        #{capa},
        #{std_weight},
        #{non_time},
        #{work_time2},
        #{facility_yn},
        #{std_jumdo},
        #{std_bijung},
        #{ch_idx}
    )
    ON DUPLICATE KEY UPDATE
        facility_name = VALUES(facility_name),
        facility_mach_code = VALUES(facility_mach_code),
        facility_comment = VALUES(facility_comment),
        c_t = VALUES(c_t),
        capa = VALUES(capa),
        std_weight = VALUES(std_weight),
        non_time = VALUES(non_time),
        work_time2 = VALUES(work_time2),
        facility_yn = VALUES(facility_yn),
        ch_idx = VALUES(ch_idx)
</insert>




<select id="getdetailMonitoring" resultType="Machine">
  SELECT
    *
  FROM
    v_geo_prodmon_view
</select>





<select id="workReport1" parameterType="Machine" resultType="Machine">
  <![CDATA[

SELECT 

    AAA.ch_idx,
    AAA.facility_name,
    L AS work_tong,  -- 작업통수
    weight_day AS now_weight, -- 작업중량
    12_hour  AS target_weight, -- 목표 통수
	ROUND(L / 12_hour * 100,1) AS per	 
FROM
(
    -- AAA 서브쿼리 (설비 정보 + 가동시간)
    SELECT 
        facility_code,
        facility_name,
        facility_mach_code,
        facility_comment,
        c_t,
        capa,
        c_t_hour * 24 AS 12_hour,
        std_weight,
        ch_idx,
        division,
        facility_name AS B,
        CASE WHEN work_gb = 0 THEN TIMESTAMPDIFF(MINUTE, CONCAT(CURDATE(), ' 08:00:00'), NOW())
             ELSE (du.work_time*60) END AS C,
        TIME_FORMAT(SEC_TO_TIME((CASE WHEN work_gb = 0 THEN TIMESTAMPDIFF(MINUTE, CONCAT(CURDATE(), ' 08:00:00'), NOW())
             ELSE (du.work_time*60) END) * 60), '%H:%i') AS C_min,
        c_t_hour AS D,
        ROUND((c_t_hour * 12), 0) AS E,
        ROUND((c_t_hour * 12), 0) * 2 AS F,
        '01:20' AS G,
        ROUND(((CASE WHEN work_gb = 0 THEN TIMESTAMPDIFF(MINUTE, CONCAT(CURDATE(), ' 08:00:00'), NOW())
             ELSE (du.work_time*60) END - TIME_TO_SEC('00:00')/60)/60),0) AS H,
        TIME_FORMAT(SEC_TO_TIME((CASE WHEN work_gb = 0 THEN TIMESTAMPDIFF(MINUTE, CONCAT(CURDATE(), ' 08:00:00'), NOW())
             ELSE (du.work_time*60) END - TIME_TO_SEC('00:00')/60)*60),'%H:%i') AS H_min,
        FORMAT(((CASE WHEN work_gb = 0 THEN TIMESTAMPDIFF(MINUTE, CONCAT(CURDATE(), ' 08:00:00'), NOW())
             ELSE (du.work_time*60) END - TIME_TO_SEC('00:00')/60)/60) * c_t_hour,1) AS I,
        "없음" AS Q,
        du.work_time,
        work_gb,
        weight_day,L
    FROM
    (
        SELECT *, 'Z' AS Z FROM tb_facility WHERE ch_idx != 9999
    ) AS fac
    LEFT OUTER JOIN
    (
     SELECT 
    'Z' AS ZZ,
    CASE 
        WHEN DATE_FORMAT(SUBSTR(#{start_time},1,8), '%Y-%m-%d') = CURDATE() 
        THEN TIMESTAMPDIFF(
                HOUR, 
                CONCAT(DATE_FORMAT(SUBSTR(#{start_time},1,8), '%Y-%m-%d'), ' 08:00:00'), 
                NOW()
             )
        ELSE 24
    END AS work_time,
    CASE 
        WHEN DATE_FORMAT(SUBSTR(#{start_time},1,8), '%Y-%m-%d') = CURDATE() 
        THEN 0 
        ELSE 1 
    END AS work_gb
    ) AS du
    ON fac.Z = du.ZZ
	INNER JOIN
	(
	    -- BBB 서브쿼리 (생산량)
	SELECT 
		mach_code, SUM(weight_day) AS weight_day, SUM(L) AS L
	FROM (
		SELECT
		    mach_code,
		    -- 전체 범위 내 개수
		    CASE 
		         WHEN end_time >= #{start_time} AND end_time <= #{end_time} THEN ROUND(weight,1) 
		         ELSE 0 
		     END AS weight_day,	    
		      CASE
		        WHEN end_time >= #{start_time} AND end_time < #{end_time}
		        THEN 1 ELSE 0
		      END AS L    
		FROM tb_lowdata_save
		WHERE start_time IS NOT NULL
		  AND end_time IS NOT NULL
		  AND end_time >= #{start_time}
		  AND end_time <  #{end_time}
	 ) AS AA
	 GROUP BY mach_code	
	) AS BBB
	ON fac.facility_mach_code = BBB.mach_code    
) AS AAA
ORDER BY AAA.ch_idx
  ]]>
</select>

<select id="workReport2_mmsql" parameterType="Machine" resultType="Machine">
  <![CDATA[
SELECT resourceID,
       indirectCode,
       downtime_name,
       cnt,
       downtime
FROM (
    SELECT resourceID,
           indirectCode,
           downtime_name,
           COUNT(*) AS cnt,
           SUM(DOWNTIME) AS downtime,
           ROW_NUMBER() OVER (
                PARTITION BY resourceID
                ORDER BY COUNT(*) DESC
           ) AS rn
    FROM V_FEMS_IF_DOWNTIME A
    WHERE ResourceID LIKE 'G0%'
      AND StartTime >= #{start_time}
      AND EndTime   <= #{end_time}
    GROUP BY resourceID, indirectCode, downtime_name
) t
WHERE rn <= 3
ORDER BY resourceID, rn;


  ]]>
</select>

<select id="workReport2_nontime_mmsql" parameterType="Machine" resultType="Machine">
  <![CDATA[
SELECT *
FROM V_FEMS_IF_DOWNTIME
WHERE ResourceID LIKE 'G0%'
  AND StartTime >= #{start_time}
  AND EndTime   <= #{end_time}
ORDER BY resourceID, downtime DESC
  ]]>
</select>

<select id="workReport3" parameterType="Machine" resultType="Machine">
  <![CDATA[
WITH err_counts AS (
    SELECT
        e.mach_code,
        e.err_name,
        COUNT(*) AS err_count,
        SUM(
            TIMESTAMPDIFF(
                SECOND,
                STR_TO_DATE(e.start_time, '%Y%m%d%H%i%s'),
                STR_TO_DATE(e.end_time,   '%Y%m%d%H%i%s')
            )
        ) AS total_seconds,
        ROW_NUMBER() OVER (
            PARTITION BY e.mach_code
            ORDER BY COUNT(*) DESC
        ) AS rn
    FROM
        ez_errdata_view_ch e
    WHERE
        e.position_cd = 'GEO'
        AND STR_TO_DATE(e.start_time, '%Y%m%d%H%i%s') 
            BETWEEN #{start_time} AND #{end_time}
    GROUP BY
        e.mach_code, e.err_name
)
SELECT
    ec.mach_code,
    f.facility_name,
    ec.err_name,
    ec.err_count,
    ec.total_seconds,
    SEC_TO_TIME(ec.total_seconds) AS total_time_hms
FROM
    err_counts ec
LEFT JOIN
    tb_facility f
    ON ec.mach_code = f.facility_mach_code
WHERE
    ec.rn <= 3
ORDER BY
    ec.mach_code, ec.err_count DESC
  ]]>
</select>

</mapper>

